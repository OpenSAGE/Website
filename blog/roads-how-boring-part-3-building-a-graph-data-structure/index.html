<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.ca8a1614af310269e24d.css">@import url(https://fonts.googleapis.com/css?family=Noto+Serif+TC|Source+Code+Pro);
/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}*{box-sizing:border-box}body,html{margin:0;padding:0;min-height:100%;display:flex;width:100%}body{font-family:"Noto Serif TC",serif;font-size:16px;line-height:1.6}h1,h2{margin-top:1em}h2{margin-bottom:.5em}h1+h2,h2+ul{margin-top:0}#___gatsby,#___gatsby>div{display:flex;height:100%;width:100%}.page{max-width:100%}#main-content,.page{display:flex;flex-direction:column;flex-grow:1;width:100%}#main-content{flex-shrink:0;padding-left:2em;padding-right:2em;margin-left:auto;margin-right:auto;margin-bottom:40px;max-width:700px}.row{display:flex;flex-direction:row;flex-shrink:0}.row+.row{margin-top:16px}.width-50{max-width:50%;flex-shrink:0}.responsive-image{display:flex;flex-shrink:1;max-width:100%}.responsive-image+.responsive-image,.responsive-image-container+.responsive-image-container{margin-left:16px}@media screen and (max-width:450px){.row{flex-direction:column}.responsive-image,.responsive-image+.responsive-image,.responsive-image-container+.responsive-image-container{margin-top:16px;margin-left:0}}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}footer{background:#000;color:#fff;font-size:12px}.footer__content{max-width:900px;margin-left:auto;margin-right:auto;padding:8px}.header__logo{height:100px;min-height:80px;background:url(/opensage-logo.png);background-size:contain;background-position:50%;background-repeat:no-repeat}.navbar{border-bottom:2px solid #000}.navbar__items{margin:0 auto 16px;list-style:none;display:flex;flex-direction:row;justify-content:center}.nav-item{display:inline-flex}.nav-item:not(last-child){margin-right:40px}.nav-item a{color:#000;text-decoration:none}.nav-item a:hover{text-decoration:underline}@media screen and (max-width:350px){.navbar__items{flex-direction:column}.nav-item{margin-left:0;margin-right:0}.nav-item:not(last-child){margin-bottom:8px}}.post-content img{max-width:100%}.post-content .gatsby-resp-image-wrapper,.post-content .video-responsive{margin-top:2em;margin-bottom:2em}.post-content h2>a,.post-content h3>a{text-decoration:none;color:initial}.post-content li>p{margin-top:2px;margin-bottom:8px}.post-content blockquote{border-left:4px solid #d3d3d3;padding-left:1em;margin-left:0}.post-content pre{color:#333;background:#eee;padding:1em;overflow-x:auto}.post-content pre code{line-height:1.2;font-size:.8rem}.post-content code,.post-content pre code{font-family:Source Code Pro,Menlo,Consolas,monospace}.post-content code{background:#eee;color:#333;padding:2px 4px}.post-metadata span{display:block}.post-metadata__author{font-weight:700}.post-content .video-responsive{overflow:hidden;padding-bottom:56.25%;position:relative;height:0}.post-content .video-responsive>iframe{position:absolute;top:0;left:0;width:100%;height:100%}.post-content .table-wrapper{max-width:100%;overflow-x:auto;border:1px solid #bdc1c4}.post-content table{border-collapse:collapse}.post-content table th{background-color:#f0f0f0;padding-left:1em;padding-right:1em;width:auto}.post-content table td,.post-content table th{border-bottom:1px solid #bdc1c4;border-right:1px solid #ccc;padding:.5rem;white-space:nowrap}</style><meta name="generator" content="Gatsby 2.17.7"/><title data-react-helmet="true">Roads? How boring! Part 3: Building a graph data structure - OpenSAGE</title><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" name="twitter:title" content="Roads? How boring! Part 3: Building a graph data structure - OpenSAGE blog"/><meta data-react-helmet="true" name="twitter:description" content="Part 3 of the series about rendering the roads in SAGE maps: Building a graph data structure"/><meta data-react-helmet="true" name="twitter:image" content="https://opensage.github.io/main-menu-social.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" property="og:title" content="Roads? How boring! Part 3: Building a graph data structure - OpenSAGE blog"/><meta data-react-helmet="true" property="og:description" content="Part 3 of the series about rendering the roads in SAGE maps: Building a graph data structure"/><meta data-react-helmet="true" property="og:url" content="https://opensage.github.io/blog/roads-how-boring-part-3-building-a-graph-data-structure/"/><meta data-react-helmet="true" property="og:image" content="https://opensage.github.io/main-menu-social.jpg"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="article:published_time" content="2020-02-21T00:00:00.000Z"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link as="script" rel="preload" href="/webpack-runtime-76635d2284914f104024.js"/><link as="script" rel="preload" href="/app-59c997f29739ee37df0a.js"/><link as="script" rel="preload" href="/styles-427ccea19fbe2d224a12.js"/><link as="script" rel="preload" href="/commons-445765d26c2d98cf103d.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-e3adbd8fe4e0926e992a.js"/><link as="fetch" rel="preload" href="/page-data/blog/roads-how-boring-part-3-building-a-graph-data-structure/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="page"><header><a href="/"><div class="header__logo"></div></a><nav class="navbar"><ol class="navbar__items"><li class="nav-item"><a href="/">About</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="https://github.com/OpenSAGE/OpenSAGE">GitHub</a></li><li class="nav-item"><a href="https://discord.gg/G2FhZUT">Discord</a></li></ol></nav></header><div id="main-content"><h1>Roads? How boring! Part 3: Building a graph data structure</h1><div class="post-metadata"><span class="post-metadata__author">Daniel Sklenitzka</span><span class="post-metadata__date">21 February 2020</span></div><div class="post-content"><p>Figuring out how to render the roads correctly in OpenSAGE turned out to be a little more challenging than expected. This is the third post in a series describing the journey. <a href="/blog/roads-how-boring-part-2-inspecting-the-map-file">Last time</a> we found out that the map files only store start and end positions for the road segments, but no information about their connections.</p>
<p>In order to decide which textures we have to draw, we need to build a graph data structure with <em>nodes</em> and <em>edges</em>. That way we can use the number of edges and the angles between them for each node to select a texture for the crossing or curve.</p>
<p>For our test map, this is what the graphs should look like:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f3b7a4b6012cd3c003bd0f1ee9f1e1f9/8ff1e/graphs.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACrUlEQVQoz1WTa1MSURjH/TCNymUv7Apok2OTIcjezmUvLIj5wiwzRdQm/Ty9dKYRLyma8RHqRe+7yLIL9MJKjRzAHmgKeebMmf/O2d//uZzdgQ/vP1arNbfiOeXK2dcz161dXf368f0n7M1Wu9lst9o37TaI5vV183fjutFo3PyLgbcnhULh1f7+TvHo9dHh9u7u9snx7nGxUDza2dvbhlUsFkqlw3enB6XSm9PTg3q9BhjYdWCk8qrsRxqDNRYjFmPWoLxOeUUOyFIAqwxBDFIZijmdsJYpls8+9WCCBIJZU+eBIYgFl+57nKYENTUIwjRC4AUkGJm6WC5/7sG2FU6ZAqRVpKAiBQjmTD0ELrQr4Mi24JFJTgclxWcaYsX50oN1KsKZpjIAq3IQqrCMkEkB4MCCYIYiPhkbk+Nhot4BXS7fgg06olOOEg5yYsRbpgDLNASd8ATz0nR4cmJMkaIGlKMwKSPiOLfKJrjTM/SmIl5Voyh5T5XG41PR+5Ni7IH4cCo8BWkTY1IsqhC/nRX6ekYa3xkSDRmITSOGaoxJx5fnMFVZKT5Mk8PadABrokEjRPanEdsHUyxgxEDlkB+KR5p/xprIz2dSZFSWfIoMV8X+7csyQ5YV6e9ZF2BOmizIEkfRCMXh5QU9/zhL0GgiMYiU7tiNECVgzaTtkb7Mui5m0qNLCyQ3b+efZFefzm4uzc0/illpwdS5jN25yBk7nEkJaUtM2/0DSyR8ctyfkkIWiugoaqC7RI1oyUFbG0LIp2nDSBtS5UGKgxT7YK7l8q0vbOW5tfSMLi6iXI6urxnreXM1p6+umGt5O58zciv6xnpq62V2azP7YgPErOc5PdituLVarep51W54nue6rud2dgjHcer1+uXl5cXFxbd6/fz8vNVq/f+r/gACVNGTjLFNqwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Road graphs"
        title="Road graphs"
        src="/static/f3b7a4b6012cd3c003bd0f1ee9f1e1f9/34e8a/graphs.png"
        srcset="/static/f3b7a4b6012cd3c003bd0f1ee9f1e1f9/d4214/graphs.png 150w,
/static/f3b7a4b6012cd3c003bd0f1ee9f1e1f9/135ae/graphs.png 300w,
/static/f3b7a4b6012cd3c003bd0f1ee9f1e1f9/34e8a/graphs.png 600w,
/static/f3b7a4b6012cd3c003bd0f1ee9f1e1f9/8ff1e/graphs.png 800w"
        sizes="(max-width: 600px) 100vw, 600px"
        loading="lazy"
      />
  </a>
    </span></p>
<p>Each node knows its position and the adjacent edges. Each edge knows its adjacent nodes. The following C# classes are used for building this data structure:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">RoadTopologyNode</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Vector3</span> Position <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>RoadTopologyEdge<span class="token operator">></span> Edges <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RoadTopologyEdge</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">RoadTopologyEdge</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">RoadTemplate</span> Template <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RoadTopologyNode</span> Start <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">RoadType</span> StartType <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RoadTopologyNode</span> End <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">RoadType</span> EndType <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We create the graphs by creating a <em>RoadTopologyEdge</em> for every pair of points in the map file. For both endpoints, we either create a new <em>RoadTopologyNode</em>, or we reuse an existing one if we already created one at <em>exactly</em> the same location and with the same type (roads of different types are never connected):</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AddSegment</span><span class="token punctuation">(</span><span class="token class-name">RoadTemplate</span> template<span class="token punctuation">,</span> <span class="token class-name">MapObject</span> start<span class="token punctuation">,</span> <span class="token class-name">MapObject</span> end<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> startNode <span class="token operator">=</span> <span class="token function">GetOrCreateNode</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> endNode <span class="token operator">=</span> <span class="token function">GetOrCreateNode</span><span class="token punctuation">(</span>end<span class="token punctuation">.</span>Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Edge case handling omitted for brevity (pun maybe intended)</span>

    <span class="token keyword">var</span> edge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoadTopologyEdge</span><span class="token punctuation">(</span>
        template<span class="token punctuation">,</span>
        startNode<span class="token punctuation">,</span>
        start<span class="token punctuation">.</span>RoadType<span class="token punctuation">,</span>
        endNode<span class="token punctuation">,</span>
        end<span class="token punctuation">.</span>RoadType<span class="token punctuation">,</span>
        Edges<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Edges<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>

    startNode<span class="token punctuation">.</span>Edges<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    endNode<span class="token punctuation">.</span>Edges<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Road alignment</h2>
<p>Before we can put our graph data structure to use, there's one more thing we need to consider. In original SAGE, connected road segments are automatically aligned so that the left and right edges of the texture are on the same side for both segments. While this is hardly noticable for normal roads, there are some road types for markings on the ground which contain written words on transparent background:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b5cff410ae4e212d1d608b381b66b828/8ff1e/not_aligned.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACTklEQVQoz11T604aQRT2kWwFlt1l77fZG6BJ0/RCLSpFqyZ9q/4yongBtH2GNukLCCzLJdWkoMVisd+wsYQ9OZk9O2e+7ztzZmbp+7cf3W4Yht2gHQTtdvOqNRyOhr+Gd3e//85sOn2EPzw8TCaT+/s/4/H48cmWGvWTyuHnavWkdn58fnpYPa7Ua2dnp9XT6lHl8OCocoD465eLy4vaZaPWqJ8PBn3ApuAD2Lcl1+Q9Ivq26JgZS2M1KSkLCeXJEWtyyjZ42+ByrtJuNefgCOYT0TZpGmBDYVQxIQkrQGpSylTTmDGUNLKrvhoHE50DsWsJSJsaa2kcZkwVJaSgCddlgBkEWUdeAJsqp4pJYnBEYyMKuGPyrpkx1DRF0kKSupwyFSYOJjqPwiDlEyHrSNiCa2WwBdBBkPLqdC8RhWuJrQWwwSOHFZ4leISqoQQ4GE0tjTEqxyMC4riyYwpUR2ddiypoMjMDMJbGI5VzZJSTdxVoIpu1pTgYzbB1pryZLxVfFwsvfDuzlsWp8GtZtlR8tVd+v731Mu8zlsqBKA6GFFhzrorOo0+o0CMStuBZnGeLmETsEpYqx8r2bInQ40Gr6YGhMeBC2yAya3sm6ggCYrA5Z/GSWDqriisKXHiuCisCtyzxzzQpoctJXcIlSWhiQpeS9Nrwy6BuNa/m4L2d4m55fae8vl16V94qlDbfYEQc/ZZLhf2PG5/2S1j2YfPt7vZGN+zMwZ2g0+v16LOaWdgJww61MPoGwfXP69vb29FoNOj3b25u8M7+v6p/b4HGzLGQ0k8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Disconnected markings (not aligned)"
        title="Disconnected markings (not aligned)"
        src="/static/b5cff410ae4e212d1d608b381b66b828/34e8a/not_aligned.png"
        srcset="/static/b5cff410ae4e212d1d608b381b66b828/d4214/not_aligned.png 150w,
/static/b5cff410ae4e212d1d608b381b66b828/135ae/not_aligned.png 300w,
/static/b5cff410ae4e212d1d608b381b66b828/34e8a/not_aligned.png 600w,
/static/b5cff410ae4e212d1d608b381b66b828/8ff1e/not_aligned.png 800w"
        sizes="(max-width: 600px) 100vw, 600px"
        loading="lazy"
      />
  </a>
    </span></p>
<p>By default, each texture is drawn from the segment's start to its end point, which is why the right one is head first. When we connect the two road segments however, the left segment is rotated by 180 degrees so the two segments are aligned:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/73c8a36011d96e9935792993e5dd5f29/8ff1e/aligned.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACSUlEQVQoz11T2XISQRTNJ0VZBmZrZt/YfLLKAhOR1SSWVX6UTylICGFJ9Bu0yh8I6xDKUCUQiSDxNGOkoOs+3Onb555z7nTvffv63XUHg4Hb6/Z63W77pjOZTCc/J/f3v/6s12r1iFgul4vF4uHh93w+f3xae63mRaX8qVq9aNTP67Vy9bzSbFxe1qq16lmlfHpWOUX+5fPV9VXjutVoNeuj0S1gK/QDOGYRR+eiphizRFvnDSWskEBE8EtPgVyJBC2NszQ24UjdTnsD9mAxU7R0WgZYkxhZ9BPBB6RCgrocwo4mhVB9EZN3wabKorFjCCjrSthQWOzoMiQEwYlQIwAzSOJ2ZAusy6wsBkyNNZWw1wJh65yj85ocokgqJKBGgrrE7IJNlYMwUMVMIW4TWHAMHhbQDoS0r0q9eC0cQ+xsgTUONQ8M52hkKDQ0mYEFfHpyoqaAfJfZ1qlI+DQUDiIlaoGetjWqf62FJB0JnOCIW2QHzGOSts4ko0GFUFelfOrj+3z20I4abD7z6rh4WMy+TMYYEKDXLvPacyjh8P9+pg0qOW7z+P+gjZoIwTHDlHlHdtQiJvVGR71WwWDIOE0vDx07700EiamFE/b2JUFNFn0SQnguCz6B3SfcM4X41UhAJbgkfkX0qyRArw23j5l32jcb8HHpzVHhoFQ4KObSxWw6/zZVyKaKudeIQjZdyKVP3mU+nORwDKWjYsYd9Dfgfr8/dId4VkPXHQ7pA+uv18BLer27H3ez2Ww6nY5ub8fjMd7Z/1f1F4J2xuQbOB6QAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Connected markings (aligned)"
        title="Connected markings (aligned)"
        src="/static/73c8a36011d96e9935792993e5dd5f29/34e8a/aligned.png"
        srcset="/static/73c8a36011d96e9935792993e5dd5f29/d4214/aligned.png 150w,
/static/73c8a36011d96e9935792993e5dd5f29/135ae/aligned.png 300w,
/static/73c8a36011d96e9935792993e5dd5f29/34e8a/aligned.png 600w,
/static/73c8a36011d96e9935792993e5dd5f29/8ff1e/aligned.png 800w"
        sizes="(max-width: 600px) 100vw, 600px"
        loading="lazy"
      />
  </a>
    </span></p>
<p>But how does the engine decide which segment should be rotated? What happens when more than two segments are connected? What about cyclic graphs?</p>
<p>It took a lot of experimenting with complex graphs like this one to figure it out:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d4dde9126bac77c009c224123d6c825c/8ff1e/aligned_graph.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACe0lEQVQoz12T/U/aQBjH/XuWLFkitEBpr6XXXu+uLQgF0TmHy0SdLC77p/YbU0TAl/k3bMn+AQsUlEQXxfm6l6c4h/rkcnnucp/n5Xt5Jr59/d7v93q9frfT7XY6/kH77Gx4enr28+Li18h+j+z29vb65ubq6vry8vLPvU3sbNfXq5/qm1utZq3Z+LxZW99ubTUb9Ua9trFerW1Um43N/S87u7ut/b3tvd3WYDAADMKFsMtVh8ouRdSQzJSoq0IKCVgVwbdwnJkSI0kLJ8CnRjxja522P4bTtmaTJAvJmCZH1OQkkEYqhpFAjYRDFZchiA4+hIMc0NkY5kQBko4WOEASnOBUwarATdm2ZOAzXAMHeG4pbf9gDDMyemEpnMjUlLAmEj0Omb0smfE43KS5lp+y4E3G0fI50vH9RzDRY1AzNBYmN8OVTetFj4c90ySUCsnTDHGSzDr6k571XM6kOAGx70jHQsUin3+ZgadwtImc5gikAhjqfwQ7TJ2ddkw95jK16DHbQtA58LMenymwfIF4GdPld5rFXao+gomeSMkRg8S8KVLMMVBLR4KOoikUxZqQdfFMgc/OOYul6bAQKrcfqq1rYiFLF0tFkBeaD9XSRCOULcHMJJQKHwlt59KGTRRqy373gdoES/kMmc4yEAyEgSZDwPr3BS5V7r9aAf2elg1FStJzUXmmy5OGGsUoYmhC6KhRkhJhR9ILOFo4htUI8P7Df15dfrNcflUuz62U51eXS7AqK6VK6CxUVhbeLb2G+7XK249rS3D54X0ZpmgMB0FwdHjY7/UPYR/NVy8IencWBN1ucHx8fH5+PhwOB0eDk5MfMGf/p+ovmF3MJTXpWY8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Aligned road graph"
        title="Aligned road graph"
        src="/static/d4dde9126bac77c009c224123d6c825c/34e8a/aligned_graph.png"
        srcset="/static/d4dde9126bac77c009c224123d6c825c/d4214/aligned_graph.png 150w,
/static/d4dde9126bac77c009c224123d6c825c/135ae/aligned_graph.png 300w,
/static/d4dde9126bac77c009c224123d6c825c/34e8a/aligned_graph.png 600w,
/static/d4dde9126bac77c009c224123d6c825c/8ff1e/aligned_graph.png 800w"
        sizes="(max-width: 600px) 100vw, 600px"
        loading="lazy"
      />
  </a>
    </span></p>
<ul>
<li>Edges created earlier are aligned to edges created later on (this is why in the example above, the left edge is rotated as it was created first).</li>
<li>At nodes with more than two edges, the second newest edge is aligned to the newest one. All others are ignored.</li>
<li>When an edge is added to a graph, the whole graph's alignment is reevaluated. This means that the newest edge in a graph determines the aligment of all other edges.</li>
</ul>
<p>In order to implement that, we need to know an edge's age. Apparently new edges are added to a map at the front of the object list, so we can use an edge's index in the list as its age. We also have to know if an edge was already aligned to another edge, so we added two properties to the <code>RoadTopologyEdge</code> class:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">int</span> Index <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> AlignedLikeIndex <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre></div>
<p>Then we can implement the alignment like this:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token comment">/// &lt;summary></span>
<span class="token comment">/// Aligns the orientation of connected road segments so that textures with</span>
<span class="token comment">/// text on them are rotated the same way.</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AlignOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Basically, edges with higher indices are rotated to match edges with </span>
    <span class="token comment">// lower indices.</span>
    <span class="token comment">// This is a bit counter-intuitive, as it is opposed to the creation order </span>
    <span class="token comment">// (the edge that was created first is the last in the list and vice versa.</span>

    <span class="token comment">// At crossings, the second edge is rotated to match the first edge.</span>
    <span class="token comment">// All other edges are not affected.</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> edge <span class="token keyword">in</span> Edges<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// If we already aligned this edge, skip to the next.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edge<span class="token punctuation">.</span>AlignedLikeIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        
        edge<span class="token punctuation">.</span>AlignedLikeIndex <span class="token operator">=</span> edge<span class="token punctuation">.</span>Index<span class="token punctuation">;</span>

        <span class="token comment">// Walk along connected edges in both directions,</span>
        <span class="token comment">// aligning them to the current edge.</span>
        <span class="token function">WalkEdges</span><span class="token punctuation">(</span>edge<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>Start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WalkEdges</span><span class="token punctuation">(</span>edge<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>End<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">WalkEdges</span><span class="token punctuation">(</span>
          <span class="token class-name">RoadTopologyEdge</span> currentEdge<span class="token punctuation">,</span>
          <span class="token class-name">RoadTopologyNode</span> currentNode<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Get the next edge connected to the current one via currentNode.</span>
            <span class="token keyword">var</span> nextEdge <span class="token operator">=</span> <span class="token function">GetNextEdge</span><span class="token punctuation">(</span>currentEdge<span class="token punctuation">,</span> currentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEdge <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Align the next edge by swapping the end points if necessary.</span>
                nextEdge<span class="token punctuation">.</span>AlignedLikeIndex <span class="token operator">=</span> currentEdge<span class="token punctuation">.</span>AlignedLikeIndex<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEdge<span class="token punctuation">.</span>Start<span class="token punctuation">.</span>Position <span class="token operator">==</span> currentEdge<span class="token punctuation">.</span>Start<span class="token punctuation">.</span>Position <span class="token operator">||</span>
                    nextEdge<span class="token punctuation">.</span>End<span class="token punctuation">.</span>Position <span class="token operator">==</span> currentEdge<span class="token punctuation">.</span>End<span class="token punctuation">.</span>Position<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    nextEdge<span class="token punctuation">.</span><span class="token function">SwapEndpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Continue along the path.</span>
                currentEdge <span class="token operator">=</span> nextEdge<span class="token punctuation">;</span>
                currentNode <span class="token operator">=</span> currentNode <span class="token operator">==</span> currentEdge<span class="token punctuation">.</span>Start <span class="token punctuation">?</span> 
                  currentEdge<span class="token punctuation">.</span>End <span class="token punctuation">:</span> 
                  currentEdge<span class="token punctuation">.</span>Start<span class="token punctuation">;</span>
                nextEdge <span class="token operator">=</span> <span class="token function">GetNextEdge</span><span class="token punctuation">(</span>currentEdge<span class="token punctuation">,</span> currentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">RoadTopologyEdge</span> <span class="token function">GetNextEdge</span><span class="token punctuation">(</span><span class="token class-name">RoadTopologyEdge</span> edge<span class="token punctuation">,</span> <span class="token class-name">RoadTopologyNode</span> node<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// If there is only one edge, we have reached the end of the path.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>Edges<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// If edge is the first edge, ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>edge <span class="token operator">==</span> node<span class="token punctuation">.</span>Edges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// ... and the second edge is not yet aligned, we can move</span>
                <span class="token comment">// along the second edge...</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>Edges<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>AlignedLikeIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> node<span class="token punctuation">.</span>Edges<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>edge <span class="token operator">==</span> node<span class="token punctuation">.</span>Edges<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// ...and vice versa.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>Edges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>AlignedLikeIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> node<span class="token punctuation">.</span>Edges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// No more edges along this path.</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Swapping the endpoints</h2>
<p>You might have noticed that the actual alignment is done by the method <code>SwapEndpoints</code>, which does exactly what its name suggests:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SwapEndpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> temp <span class="token operator">=</span> Start<span class="token punctuation">;</span>
    Start <span class="token operator">=</span> End<span class="token punctuation">;</span>
    End <span class="token operator">=</span> temp<span class="token punctuation">;</span>

    <span class="token comment">// This is actually a bug in the original engine:</span>
    <span class="token comment">// We should swap StartType and EndType as well,</span>
    <span class="token comment">// but then we couldn't recreate the original behavior.</span>

    <span class="token comment">// var tempType = StartType;</span>
    <span class="token comment">// StartType = EndType;</span>
    <span class="token comment">// EndType = tempType;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As you can tell from the comment, there seems to be a bug in the original engine. Normally, when two segment are connected, their endpoints are merged into one. We can then set the corner type for this node as described in <a href="/blog/roads-how-boring-part-1-taking-stock">part 1</a>. This road type is then stored redundantly in both map objects that make up the two end points of the two edges. When we swap the end points of one of the edges (but not their road types), it can happen that the two edges disagree about the corner type. This can also be seen in World Builder:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/84ac070a9f2307cba1641af546a7774a/2d493/corner_type_bug.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 83.68932038834951%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAADqUlEQVQ4yz1Ua28bRRT1HylqmyrxI971q0VRrSR+7/s1u2u7IoiUNhWiVVDbAG0S200KIZFA8AF+WyU+QxFVJCQKSIndw5lZgaXRWHfunHvOPXc29+rVz3jz5hy/vf4dv/7yGufnf+Dtn3/jr7f/4OJijsvLBRYL/L8uLha4ZHwxz/7PF+8gf/JsPn+H3NnpY7w83sXx0WfcH+Lk68c4O32i9snkUxzNdnF68hRnZ3uMf4HZ7BGOJ5/w/x5OvnmCl1/t4rtv9/HD9xP89OMMOctcgWVch20uwTCvw7eWEXAZ/WsYdK6h3b2Cvsn//asq5lg34DnLcOwldccyltBpv4d26wrPryIXBlXEURVpXEPE1fU20IxuYcNeQ6fVhO3eQvxBGWGiQYQ6EubcGTW4V2FbJYR+BVFYgYh0tecSUYPvrSLwVyG8KvqDDdjOKsxBEZZZQ6ezjtSrwA9KiAIdYaARrKLAbbMI0yiQbQmJIDDPcqO0wSplonM5Ovq9dR6ssvoKpRUptYnQqalYJBkKXRUPA7L2NeYV4DJPFhgmZDhM6kgimVRG0C/B6LYggvcJVodtVzEwW4i8mxjFOnx3lXGq8TIC8o7vlhUzEWoZoOydOmCS8EvoeQ1sBmuwnE3YxiZ8u41gXIe7VYAtigTTFEAUZECjYQ2jtIphWlGycxFNMQZ5OrSCgFXFkDJEAUFUwpAy7lBimLKQWIHhUB6NENF/oJpiGlPheJh5QZcrNCDPcSgqKWNWE0wKaULMfcjkWGgcj6JanlNCmlSyXkpVoQTVFDsFKK2WBy6dctwiDLo+GHGRuUeXY8aDMXsXlwhYUD2Mha6YSYA4qiiTPN5VLqdxPTOEh76vo2u1YIVNDjnnsNNEp0uDIo5UqiH0yqq4lCj7lsYZK5dFpGEynosjsmBPBC/FfpXSu3S5zIoFVqzwFdyGZ7GPvJgmNSU1iTUFJsdGsvO9bEYVw4Cs5BzKuYpcnf1sq1EwDT5JM48+5zD2G4wVFQt5aZhUFZA002bvHbuoWiBx1EuRMuRTGjM4cG+j464RqI7B4Cba7XXGGwjotC+YJzgiZCqNkC/Ec7NZlIRioeawygBnzMrTmGUm5NGjlPWujvZGHe1eDXZCJlvLcAM+M7K2DH5AKFOy7nVvsE15suM4hXR5Nn2Aoxc7eP5sG0/3PsSL/bs4PtjGl59v4eDZRzg43MZ0dp+fsQeYHu7gYP8e9p/fxWy6o9bk8B4/c/cxVetj/AstIKRPB2/m7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Image showing the bug"
        title="Image showing the bug"
        src="/static/84ac070a9f2307cba1641af546a7774a/34e8a/corner_type_bug.png"
        srcset="/static/84ac070a9f2307cba1641af546a7774a/d4214/corner_type_bug.png 150w,
/static/84ac070a9f2307cba1641af546a7774a/135ae/corner_type_bug.png 300w,
/static/84ac070a9f2307cba1641af546a7774a/34e8a/corner_type_bug.png 600w,
/static/84ac070a9f2307cba1641af546a7774a/fea0e/corner_type_bug.png 900w,
/static/84ac070a9f2307cba1641af546a7774a/2d493/corner_type_bug.png 1030w"
        sizes="(max-width: 600px) 100vw, 600px"
        loading="lazy"
      />
  </a>
    </span></p>
<p>The labels show the corner types of the segment end points, the arrows show the segment directions (start to end). In the lower graph, one edge has an opposing direction and thus is rotated by the alignment algorithm. This causes the lower left corner to be incorrectly rendered as a broad curve (the default value), even though both edges say it should be a tight curve.</p>
<p>We'll have to keep that in mind for when we start rendering curves. Before we can do that though, we need to render straight road segments. In fact, we'll start doing that in the <a href="/blog/roads-how-boring-part-4-rendering-straight-roads">next post</a>.</p></div></div><footer><div class="footer__content"><p>OpenSAGE is not associated with Electronic Arts or any other company. All trademarks are property of their respective owners. Screenshots of copyrighted works are only used for demonstration purposes.</p><p>© OpenSAGE <!-- -->2020</p></div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/roads-how-boring-part-3-building-a-graph-data-structure";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-59c997f29739ee37df0a.js"],"component---src-templates-post-js":["/component---src-templates-post-js-e3adbd8fe4e0926e992a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-96234cfd34c652336484.js"],"component---src-pages-blog-js":[],"component---src-pages-index-js":["/component---src-pages-index-js-beb6b69b41c8d8f8ccd6.js"]};/*]]>*/</script><script src="/component---src-templates-post-js-e3adbd8fe4e0926e992a.js" async=""></script><script src="/commons-445765d26c2d98cf103d.js" async=""></script><script src="/styles-427ccea19fbe2d224a12.js" async=""></script><script src="/app-59c997f29739ee37df0a.js" async=""></script><script src="/webpack-runtime-76635d2284914f104024.js" async=""></script></body></html>