<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-post-js.f27fa0a09aa2e903b193.css">footer{background:#000;color:#fff;font-size:12px}.footer__content{max-width:900px;margin-left:auto;margin-right:auto;padding:8px}.header__logo{height:100px;min-height:80px;background:url(/opensage-logo.png);background-size:contain;background-position:50%;background-repeat:no-repeat}.navbar{border-bottom:2px solid #000}.navbar__items{margin:0 auto 16px;list-style:none;display:flex;flex-direction:row;justify-content:center}.nav-item{display:inline-flex}.nav-item:not(last-child){margin-right:40px}.nav-item a{color:#000;text-decoration:none}.nav-item a:hover{text-decoration:underline}@media screen and (max-width:350px){.navbar__items{flex-direction:column}.nav-item{margin-left:0;margin-right:0}.nav-item:not(last-child){margin-bottom:8px}}.post-content img{max-width:100%}.post-content h2>a,.post-content h3>a{text-decoration:none;color:initial}.post-content li,.post-content p{text-align:justify}.post-content blockquote{border-left:4px solid #d3d3d3;padding-left:1em;margin-left:0}.post-content pre{color:#333;background:#eee;padding:1em;overflow-x:auto}.post-content pre code{line-height:1.2;font-size:.8rem}.post-content code,.post-content pre code{font-family:Source Code Pro,Menlo,Consolas,monospace}.post-content code{background:#eee;color:#333;padding:2px 4px}.post-metadata span{display:block}.post-metadata__author{font-weight:700}.post-content .video-responsive{overflow:hidden;padding-bottom:56.25%;position:relative;height:0}.post-content .video-responsive>iframe{position:absolute;top:0;left:0;width:100%;height:100%}.post-content .table-wrapper{max-width:100%;overflow-x:auto;border:1px solid #bdc1c4}.post-content table{border-collapse:collapse}.post-content table th{background-color:#f0f0f0;padding-left:1em;padding-right:1em;width:auto}.post-content table td,.post-content table th{border-bottom:1px solid #bdc1c4;border-right:1px solid #ccc;padding:.5rem;white-space:nowrap}</style><style data-href="/app.707689fd342d7d5d726e.css">@import url(https://fonts.googleapis.com/css?family=Noto+Serif+TC|Source+Code+Pro);
/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}*{box-sizing:border-box}body,html{margin:0;padding:0;min-height:100%;display:flex;width:100%}body{font-family:"Noto Serif TC",serif;font-size:16px;line-height:1.6}h1,h2{margin-top:1em}h2{margin-bottom:.5em}h1+h2,h2+ul{margin-top:0}#___gatsby,#___gatsby>div{display:flex;height:100%;width:100%}.page{max-width:100%}#main-content,.page{display:flex;flex-direction:column;flex-grow:1;width:100%}#main-content{flex-shrink:0;padding-left:2em;padding-right:2em;margin-left:auto;margin-right:auto;margin-bottom:40px;max-width:700px}.row{display:flex;flex-direction:row;flex-shrink:0}.row+.row{margin-top:16px}.width-50{max-width:50%;flex-shrink:0}.responsive-image{display:flex;flex-shrink:1;max-width:100%}.responsive-image+.responsive-image,.responsive-image-container+.responsive-image-container{margin-left:16px}@media screen and (max-width:450px){.row{flex-direction:column}.responsive-image,.responsive-image+.responsive-image,.responsive-image-container+.responsive-image-container{margin-top:16px;margin-left:0}}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.0.73"/><title data-react-helmet="true">OpenSAGE Dev Diary #1 - OpenSAGE</title><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><link as="script" rel="preload" href="/webpack-runtime-8f567eee25327b902e4a.js"/><link as="script" rel="preload" href="/app-dd237348fec3d4ff6d22.js"/><link as="script" rel="preload" href="/0-66784dde14951553257f.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-ffb8b33bd18fe85cd459.js"/><link as="fetch" rel="preload" href="/static/d/1/path---blog-dev-diary-1-99-c-2f1-PKLZddd61VebpkZGHQoLEKZRk.json" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="page"><header><a href="/"><div class="header__logo"></div></a><nav class="navbar"><ol class="navbar__items"><li class="nav-item"><a href="/">About</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="https://github.com/OpenSAGE/OpenSAGE">GitHub</a></li><li class="nav-item"><a href="https://discord.gg/G2FhZUT">Discord</a></li></ol></nav></header><div id="main-content"><h1>OpenSAGE Dev Diary #1</h1><div class="post-metadata"><span class="post-metadata__author">Tim Jones</span><span class="post-metadata__date">03 December 2017</span></div><div class="post-content"><p><em><a href="http://timjones.io/blog/archive/2017/12/03/opensage-dev-diary-2017-12-03">This post</a> was originally published on Tim's blog.</em></p>
<p>This is the first in what I hope will be a continuing series of updates on <a href="https://github.com/OpenSAGE/OpenSAGE">OpenSAGE</a>, my C&#x26;C Generals re-implementation project.</p>
<p>I've been working on OpenSAGE for about 6 months now. I'm still working on parsing and rendering the basic data files (3D models, maps, etc.). There isn't yet any playable executable. Instead, there's a "Data Viewer" application, which lists all the files found in the Generals (or Zero Hour) installation folder, and lets you view these files. I've found this approach helpful while writing parsers for the various file formats found in Generals. At some point, I'll transition to working on gameplay, and start to build up a playable executable.</p>
<p>Here is what the data viewer looks like. Here I'm viewing the USA Command Center 3D model:</p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/275cb876d955abcee1b17a8f008f40c7/1ee56/opensage-2017-12-03-data-viewer.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 600px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACbUlEQVQoz3WS30tTYRjHz5/SXdBlf0IEhVkXCjrn3HQ7v89Z27Tj3HSubYEiMTPTRT8kUlKCJLAfdrMuQryQroTcRrkrjZ2tTZkabJNv7/tO54Q88OX78jzP++F5zvNyqz9WkdxOIplNIrGRQPx7HNHPUViClrqGLejwdTDRcyN+os5gJ3PbiA1dw13gDkoHONo/Av3K5TLzra0tqIIKTdSgizp0SYcmadAErRGjfk4nOW739w7MgolKrYLj42MGzKQzkGQJsiJDVmUoqsLOoiQyF0QBkkpz9XizuKJZxOH+IQNVq1Xm6XQaskxApECSJIiiiF57N+w9dvT0OOD2DMCnuyEIPMmL0DWN1CrsDrf+cx1rv9awaW6iUq00gBQkywq8Xh+i4QAZ2QnRZYN/eASGtRfOllvQvQaCgVFYrd2kXmZQLrubxfbONvb+7qFaO+0wBVVV4XL24p7bhZjfiwGPgmgojFGLDTcvX4K9z47JyRncud2G0JAX/T4fa4IrFooo/SkxUK1WY55KpaBpOgyfBkNzoKu9BdduXIe9tRXtV6+gz9GGuUQcc89m4JGs+Lg4Ba/nbh2YL+RRKBTYQk6BmUyG/B8B/kEDTyZCePNiGrFRPxnZirGIByuLCSzNz+Pl7COMh/sxFhsBT+rZyKZpgqoZeLYUBYPGABKPp5D88BbvXj/F7MMo3i+9IlrAt08EOjOBwJCfbF6sA3O5HPL5/H+BVHTDLpeLXDJYx3Ss+6EgFp5PY+PrMr6sLJMaicEaQKqLgKeFgiAyOH1KdDzaUSwSxoNoBDwvnAdeNHIz8ExnMQrieb7xBqn/A/EfjydiBWyVAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="OpenSAGE Data Viewer"
        title=""
        src="/static/275cb876d955abcee1b17a8f008f40c7/7a630/opensage-2017-12-03-data-viewer.png"
        srcset="/static/275cb876d955abcee1b17a8f008f40c7/46d37/opensage-2017-12-03-data-viewer.png 150w,
/static/275cb876d955abcee1b17a8f008f40c7/c218a/opensage-2017-12-03-data-viewer.png 300w,
/static/275cb876d955abcee1b17a8f008f40c7/7a630/opensage-2017-12-03-data-viewer.png 600w,
/static/275cb876d955abcee1b17a8f008f40c7/91b84/opensage-2017-12-03-data-viewer.png 900w,
/static/275cb876d955abcee1b17a8f008f40c7/b8f57/opensage-2017-12-03-data-viewer.png 1200w,
/static/275cb876d955abcee1b17a8f008f40c7/6f30d/opensage-2017-12-03-data-viewer.png 1800w,
/static/275cb876d955abcee1b17a8f008f40c7/1ee56/opensage-2017-12-03-data-viewer.png 2880w"
        sizes="(max-width: 600px) 100vw, 600px"
      />
  </span>
  </a></p>
<p>I meant to start writing about this project soon after I started it, but clearly that didn't happen. Instead of trying to list everything I've done in the last 6 months, I'll just start from a week ago, and then try to keep up-to-date from now.</p>
<h2>Progress this week</h2>
<p>This week, I have:</p>
<ul>
<li>Switched from a D3D12 renderer to a D3D11 renderer. I started out with a Direct3D 12 renderer because I wanted to learn Direct3D 12. Having done that, I realise it's not sensible for this particular project to require an API that only works on Windows 10. Direct3D 11 works on Windows 7 and above, and since many people are still on Windows 7, that's a better minimum requirement. I plan to add a Metal renderer (for macOS and iOS), and possibly Vulkan (for Android), depending on how popular this project is.</li>
<li>In order to render the terrain and 3D meshes, I was previously relying on a D3D12-only feature called dynamic texture indexing. This allowed me, for example when rendering a map, to put all the terrain textures in a big array and send that to the GPU, and the pixel shader could dynamically index the right texture. Dynamic texture indexing of an array of textures (i.e. <code class="language-text">Texture2D[]</code>) isn't supported in D3D11, so I instead used D3D11's closest equivalent, a texture array (<code class="language-text">Texture2DArray</code>).</li>
<li><code class="language-text">Texture2DArray</code> requires all the textures in the array to have the same size and format (unlike <code class="language-text">Texture2D[]</code>, where textures can have arbitrary sizes and formats). The terrain textures used in Generals maps are not all the same size. There are 4 possible sizes: 64x64, 128x128, 256x256, and 384x384. In order to put all these into a <code class="language-text">Texture2DArray</code>, I had to upsample the smaller textures to 384x384. Not a perfect solution, but it was the least bad option I could think of, while keeping the nice ability to render an entire terrain patch with a single draw call.</li>
<li>Added a friendlier resource binding API. Previously, to set shader resources, I had to hard-code the resource slot in my C# code. Now I can use the name of the resource, as declared in HLSL, and using shader reflection I can match this to the resource slot.</li>
<li>Added a stub for a Bink video parser. Currently I can parse the container format, but not yet any of the video or audio packets. Cinematic videos in Generals use the Bink video format (stored in <code class="language-text">.bik</code> files), and up to now I've had a prototype Bink viewer that uses <a href="https://www.ffmpeg.org/">FFmpeg</a> to play them. I'm toying with the possibility of implementing a Bink parser and renderer completely in C#, to remove the FFmpeg dependency. Native dependencies cause all sorts of headaches for cross-platform deployments, so I'd like to avoid them if I can. That said, Bink is not a simple format, so it might turn out to be a bad idea to try to implement it myself.</li>
<li>Fixed some memory leaks. I noticed, when shutting down the data viewer app, that Direct3D complained in the Visual Studio output window about unreleased live resources. I tracked these down to a place where I'd forgotten to dispose some D3D objects.</li>
<li>Abstracted the material system to support shader materials. 3D models in Generals and Zero Hour all use vertex materials, which were built on D3D8's fixed-function pipeline. Later SAGE games (Battle for Middle-earth II, C&#x26;C3, RA3) use shaders. I wanted to support both types of rendering early on, so that I don't need to do lots of refactoring later. Model rendering can now use either <code class="language-text">FixedFunctionMaterial</code> (which still uses shaders, but it emulates a Generals-era fixed-function pipeline) or <code class="language-text">ShaderMaterial</code>.</li>
</ul>
<p>So, lots of refactoring and internal changes this week.</p>
<p>Next week I plan to work on the GUI. I have a prototype GUI renderer, built on WPF. I plan to rip this out and build a new one based on lower-level drawing APIs (Direct2D on Windows, and later, <code class="language-text">CGContext</code> on macOS and iOS). Stay tuned!</p>
<p>Although I haven't done any work on maps this week, allow me to finish with a screenshot showing the current state of map rendering:</p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/29696888406f45b076d3705dc3e0771d/1ee56/opensage-2017-12-03-data-viewer-map-usa03.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 600px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAADJElEQVQozx2SWU9bVxSF7x+smoeqRU1bVGMHbGMbz9fX83yNB2xfG2PwwOQUREJjoElpISVqRBXlFamV+kRewKbGQGlUMvDlJEfaWtLSOXvtddaWukddtv/apvtnl+ZvbVYP11h81qa+W6Wxv0D18Sy17jzNJ4vM/zpPY6/OgsDZx1WWf19l5fkyzf06Gy8fCGwiXZ5fcvHPBe9v3rP1cIfdnafsbe/SLC/wfP8lTa1FNTfLYm2JdqXF1tojnv18wHprnbbW5OHyGp35Be43lujUG0invVNOez1e//+aWr1MNqeytv4jrXaHX/aeolVLyB4PjVqDJcEdHPzBk5+6LLWWiQcj1GfrtOfK1CtlVheXkM7Ozuj3+1xdXdFqNYlG4zQaK6LaRGIBAkGZmZkK+UKJjY0tNrvbdFY7BIMKajrLo80dNh/8gFYq0lj4aPnikuFgyPXVNSsr90kkVIrFCtlsnlQqRSqtksnOCEziDykkMxkKhQKGiW9IqWlKpTIOjwm3bGe2Nod0fHrMq94rBtcDKprGlNWGXwkge30oso9oMEQ+VxACOXyyl3AoSDweIRgK4PU6GdV/waTVgMM+ic1uRjr8+5AXxy84OjtC0yo47Q7cThc+r4Ls9mIy6PBMWckkIuTUBIpoosYipGNRpvMqJqsOu8NKXHAJcUca9Afc/HfDx9NsNIVNlVx+Rtjz47QYcUyasY59SzIaJCI4xesVkyukEynqVY2w4iUWC6GVy2KgOlKv36N/JkL594pcISk+O4BDPHLJHqxTJuw2IyGfl4IQsU1MEFFcFPPT+DxubCYhaNaRyySpVaZJJVWk4XDI7e0tb9+9JZaUMYyPodPr8bhlHG4zgbBHhFDE7rYRiUZFODkhoGDRf0ciHiOvBkinM/j9IexTU0jn5+ei2btPltVMgpGRzzGO67FbrExO6nG6TKSTSVwes7DqZzpVECsyRz6r4XK4GR0d5e7XX2Ex3yMcCCGdnJwwGAx48+aGdDXFl8bPGJfHmPDdE6hH5xnBGBjDGXfgUxWsYTNGvx5L0Mb3jlGMvnFGLHe4a7uDKWjgA6u2lR6KeSfsAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="OpenSAGE Data Viewer - USA03 Map"
        title=""
        src="/static/29696888406f45b076d3705dc3e0771d/7a630/opensage-2017-12-03-data-viewer-map-usa03.png"
        srcset="/static/29696888406f45b076d3705dc3e0771d/46d37/opensage-2017-12-03-data-viewer-map-usa03.png 150w,
/static/29696888406f45b076d3705dc3e0771d/c218a/opensage-2017-12-03-data-viewer-map-usa03.png 300w,
/static/29696888406f45b076d3705dc3e0771d/7a630/opensage-2017-12-03-data-viewer-map-usa03.png 600w,
/static/29696888406f45b076d3705dc3e0771d/91b84/opensage-2017-12-03-data-viewer-map-usa03.png 900w,
/static/29696888406f45b076d3705dc3e0771d/b8f57/opensage-2017-12-03-data-viewer-map-usa03.png 1200w,
/static/29696888406f45b076d3705dc3e0771d/6f30d/opensage-2017-12-03-data-viewer-map-usa03.png 1800w,
/static/29696888406f45b076d3705dc3e0771d/1ee56/opensage-2017-12-03-data-viewer-map-usa03.png 2880w"
        sizes="(max-width: 600px) 100vw, 600px"
      />
  </span>
  </a></p></div></div><footer><div class="footer__content"><p>OpenSAGE is not associated with Electronic Arts or any other company. All trademarks are property of their respective owners. Screenshots of copyrighted works are only used for demonstration purposes.</p><p>© OpenSAGE <!-- -->2018</p></div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-js","jsonName":"blog-dev-diary-1-99c","path":"/blog/dev-diary-1"};window.dataPath="1/path---blog-dev-diary-1-99-c-2f1-PKLZddd61VebpkZGHQoLEKZRk";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.707689fd342d7d5d726e.css","/app-dd237348fec3d4ff6d22.js"],"component---src-templates-post-js":["/component---src-templates-post-js.f27fa0a09aa2e903b193.css","/component---src-templates-post-js-ffb8b33bd18fe85cd459.js"],"component---src-pages-404-js":["/component---src-pages-404-js-43530a00cc2c0247be06.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js.ad58bdd054f14d0f4836.css","/component---src-pages-blog-js-6baa3245fa58823c2755.js"],"component---src-pages-index-js":["/component---src-pages-index-js.ad58bdd054f14d0f4836.css","/component---src-pages-index-js-1d26c4b2bb534136a8c2.js"]};/*]]>*/</script><script src="/component---src-templates-post-js-ffb8b33bd18fe85cd459.js" async=""></script><script src="/0-66784dde14951553257f.js" async=""></script><script src="/app-dd237348fec3d4ff6d22.js" async=""></script><script src="/webpack-runtime-8f567eee25327b902e4a.js" async=""></script></body></html>